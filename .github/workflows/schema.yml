name: schema
on:
  workflow_call:
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday 00:00 UTC

permissions:
  contents: read
  issues: write

jobs:
  schema-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout workflow code
        uses: actions/checkout@v4
        with:
          repository: cloudnationhq/terraform-azure-workflows
          path: workflow-repo

      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.repository.full_name }}
          path: target-repo

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run schema tests
        working-directory: workflow-repo/tests/schema
        run: |
          go mod tidy
          go test -v .
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TERRAFORM_ROOT: ${{ github.workspace }}/target-repo
